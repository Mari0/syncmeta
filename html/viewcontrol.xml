<?xml version="1.0" encoding="UTF-8" ?>
<!-- generated on Tue Mar 03 2015 19:28:16 -->
<Module>
  <ModulePrefs
    title="View Control"
    description=""
    author="Stephan Erdtmann"
    author_email="erdtmann@dbis.rwth-aachen.de"
    width="100"
    height="300">

    <Require feature="opensocial-0.8" ></Require>
    <Require feature="openapp" ></Require>
    <Require feature="dynamic-height"></Require>

    <OAuth>
      <Service name="openapp" xmlns:openapp="http://www.role-project.eu/xml/openapp/opensocialext/"
               openapp:service="http://purl.org/role/terms/spaceService"
               openapp:permitReadAppend="http://purl.org/role/terms/data">
        <Request method="" url=""></Request>
        <Authorization url=""></Authorization>
        <Access method="" url=""></Access>
      </Service>
    </OAuth>

  </ModulePrefs>
  <Content type="html">
    <![CDATA[
    <script type="application/javascript">
        (function(){
          var cnt = 30; // 5 attempts per second => 6 seconds
          var timeout = function(){
              var btn = document.getElementById("oauthPersonalizeButton");
              var wrapper = document.getElementById("oauthPersonalize");
              if(wrapper && wrapper.offsetParent !== null && btn && btn.onclick){
                  var win = null;
                  var openWindow = window.open;
                  window.open = function(){return win = openWindow.apply(window,arguments);};
                  btn.onclick.call(btn);
                  if(win){
                      win.onload = function(){
                          win.document.getElementsByTagName("form")[0].submit();
                          setTimeout(function(){
                              window.location.reload();
                              if(win){
                                  win.close();
                              }
                          },1000);
                      };
                  }
              } else {
                  if(cnt > 0){
                      cnt -= 1;
                      setTimeout(timeout,200);
                  }
              }
          };
          timeout();
        })();
    </script>
    <script src="http://localhost:8081/js/config.js"></script>
    <script src="http://localhost:8081/js/lib/vendor/require.js"></script>    
    <link rel="stylesheet" type="text/css" href="http://localhost:8081/css/vendor/jquery-ui.css">
<link rel="stylesheet" type="text/css" href="http://localhost:8081/css/style.css">
<script type="application/javascript">
	 requirejs(['jqueryui','lodash'],function($,_){
			
			
			$(function(){
				var getCurrentSpaceURI = function(space){
					var deferred = $.Deferred();
					space.getInfo(function(info) {
						var spaceuri = info[openapp.ns.conserve+ "owner"].substring(0,info[openapp.ns.conserve + "owner"].lastIndexOf("/"));
						deferred.resolve(spaceuri);
					});
					return deferred.promise();
				};
				function addWidgetToSpace(spaceURI,widgetURL){
					var deferred = $.Deferred();
					openapp.resource.post(
                        spaceURI,
                        function(data){
                            deferred.resolve(data.uri);
                        },{
                            "http://www.w3.org/1999/02/22-rdf-syntax-ns#predicate":"http://purl.org/role/terms/tool",
                            "http://www.w3.org/1999/02/22-rdf-syntax-ns#type":"http://purl.org/role/terms/OpenSocialGadget",
                            "http://www.w3.org/2000/01/rdf-schema#seeAlso":widgetURL
                        }
					);
					return deferred.promise();
				};
				
				var iwcClient;
				gadgets.util.registerOnLoadHandler(function(){
					iwcClient = new iwc.Client();
					iwcClient.connect(); 
				});
				var space = new openapp.oo.Resource(openapp.param.space());
				var templateString = '<tr><td class="lblviewname" uri=<<= uri >>><<= name >></td><td><input class="btnViewListShow" type="button" value="Show"></td><td><input type="button" class="btnViewListDel" value="Delete"></td></tr>'.replace(/<</g,"<"+"%").replace(/>>/g,"%"+">");
				var tpl = _.template(templateString);
				
				space.getSubResources({
					relation: openapp.ns.role + "data", type: "my:ns:item",
					onEach: function(item) {
						_uri = item.uri;
						item.getRepresentation("rdfjson",function(rep){
							var $viewEntry = $(tpl({name: rep.name, uri: _uri}));
							$viewEntry.find('.btnViewListDel').click(function(evt){
								var resource_uri = $(evt.target).parents('tr').find('.lblviewname').attr('uri');
								openapp.resource.del(resource_uri,function(data){
									window.location.reload();
									//alert("Deleted resource: " + resource_uri);
								});
							});
							$viewEntry.find('.btnViewListShow').click(function(evt){
								getCurrentSpaceURI(space).then(function(currentSpaceURI){
									addWidgetToSpace(currentSpaceURI, "http://localhost:8081/viewcanvas.xml").then(function(){	
										var viewpointName = $(evt.target).parents('tr').find('.lblviewname').text();
										var intent = { 
											"component": "",
											"data": viewpointName,
											"dataType":"text/json",
											"action":"ACTION_UPDATE",
											"flags" :["PUBLISH_GLOBAL"],
											"extras" :{"ns":"my:ns:item"} 
										};
										//iwcClient.publish(intent); 
									});
								});
							});
							$('#viewlist').append($viewEntry);
							
						});	
					} 
				}); 
				
				$('#btnCreateView').click(function(){
					var text = {"name":$('#txtCreateView').val()};
					space.create({
						relation: openapp.ns.role + "data",
						type: "my:ns:item", 
						representation: text,
						callback: function(subres){ 						
							window.location.reload();
							alert("Successfully stored");
						}
					}); 
				});
				
				
			});
	 });
</script>
<style>
	td {
		padding: 5;
	}
</style>
<div id="viewcontrol">
	<p id="createview">
		<input type="text" id="txtCreateView" size="10" maxlength="30">
		<input type="button" id="btnCreateView" value="CreateView">
	</p>
	<div id="viewlist">
		<strong>Viewpoint List</strong>
		<table id="viewlist"></table>
	</div>
</div>
    <script src="http://localhost:8081/js/shared.js"></script>    
    ]]>
  </Content>
</Module>
